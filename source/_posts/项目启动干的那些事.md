---
title: 项目启动干的那些事!
date: 2018-05-31 13:12:46
tags: [OC]
---



<H1 style="color:red" align="left"> 这篇文章可能涉及到了很多的面,所以打算分期来写完(还不知道什么时候能写完... </H1>
- `main`函数之前做了哪些事
-  `main`函数到`didFinishLaunchingWithOptions`做了哪些事
-  `didFinishLaunchingWithOptions`到页面完全显示做了哪些事
- 启动时间如何优化 

# `main`函数之前做了哪些事
[TOC]

## 查看main函数前调用

在14年WWDC大会有一个[session](https://developer.apple.com/videos/play/wwdc2016/406/)专门讲到这块.
内容太多,挑出关键点如下:
在 项目设置中添加环境变量 `DYLD_PRINT_STATISTICS` ,其value值为 1.
![设置环境变量](Snip20180531_1.png)

在配置完环境变量后,重新启动项目,可以在控制台看到如下打印:

```
Total pre-main time: 1.0 seconds (100.0%)
         dylib loading time: 826.49 milliseconds (80.3%)
        rebase/binding time:  84.88 milliseconds (8.2%)
            ObjC setup time:  41.54 milliseconds (4.0%)
           initializer time:  75.08 milliseconds (7.3%)
           slowest intializers :
             libSystem.B.dylib :   6.57 milliseconds (0.6%)
```

这个官方描述很全面了,意思就自己看看啦.

这里共计 6 项内容,而这6项就是在`main`函数之前所干的事,也是我们该篇文章中下一步讨论的重点.

> PS: 在设置完环境变量后,真机模拟器是没有问题的,但是在越狱机上不能正常显示,还请大佬指教.

<H2 style="color:blue" align="center"> 到目前为止就开始了真是的main之前... </H2>
<H3 align="left"> 1. dylib loading </H3> 

<H3 align="left"> 2. rebase/binding </H3>
<H3 align="left"> 3. ObjC setup </H3>
<H3 align="left"> 4. initializer </H3>
<H3 align="left"> 5. slowest intializers </H3>
<H3 align="left"> 6. libSystem.B.dylib </H3>

# 基本知识
## 程序启动加载过程(单进程的)

1. 内核创建进程,分配虚拟的进程空间,加载链接器.
2. 加载APP主二进制以后能用的库,绑定符号,类等等信息.
3. 启动程序.

## mach-o(Mac/iOS中二进制格式)
翻看网上一大堆,这里就来捋一捋.
需要文档:
1. mach-o 数据结构定义文件`loader.h`.
 在这个文件中定义了N多个结构体,同时这也是在mach-o 中主要的文件目录.
路径 : 
**/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/mach-o**
要想完全理解mach-o 的内部结构,就需要对这个文件相当熟悉.
2. mach-o 的内部结构
在理解mach-o 的内部结构时,先来对mach-o来一个预览.
正常来说你会看到如下图: 

![mach-o基本结构](v2-35f7008ce676b29129f9ec8bed3c464f_r.jpg)

有时候,你会发现你打包出来后的mach-o或许比这个要多,例如:

![fat mach-o](674044-c92a474eac903834.png)
导致这两种原因是因为你在xcode配置的二进制指令集的问题.
### mach-o 的生成及查看
#### mach-o 生成
如上所说最后的mach-o是配置的问题.你可以在xcode中按照如下配置进行:
![生成指令集配置](Snip20180531_7.png)
如图中设置:
	1.  `Architectures` 指定工程被编译成可支持哪些指令集类型，而支持的指令集越多，就会编译出包含多个指令集代码的数据包，对应生成二进制包就越大，也就是ipa包会变大.
	2. `Build Active Architecture Only` 这是指在各个build configuration下是否只针对当前连接到设备(真机或模拟器)进行编译生成.
	3. `Valid Architectures` 限制可能被支持的指令集的范围,是指能够生成的指令集包含哪些.
	
> 如果说 `Build Active Architecture Only`设置成true 的话,最后生成的mach-o 就是一个fat的,	其中包含了arm64 ,armv7(32位) , armv7s(32位) 三种指令集.(具体哪些机型对应哪些指令集可查看[这篇文章](http://www.cocoachina.com/ios/20140915/9620.html))

#### mach-o 查看
查看方式可以多种多样,这里就说两种常用的.
1. 使用`otool` ,这个函数有很多选项,可以查看自己想看的部分
![otool 查看](Snip20180531_9.png)
这里会包含你想查看部分的数据结构
2. 使用machOview查看. 可视化工具,还是不错的.
![machOview查看](Snip20180531_10.png)

接下来就来具体的看看mach-o对应的各个结构




# dylib loading







